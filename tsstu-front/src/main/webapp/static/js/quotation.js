//var history_list = {"market":"IB","code":"GBP.USD","data":[{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 16:11:00","open":1.23767,"high":1.23773,"low":1.23767,"close":1.23771},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 16:10:00","open":1.23775,"high":1.2378,"low":1.23763,"close":1.23773},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 16:09:00","open":1.23767,"high":1.23792,"low":1.23761,"close":1.23781},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 16:08:00","open":1.23795,"high":1.23802,"low":1.2377,"close":1.2377},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 16:07:00","open":1.23733,"high":1.23801,"low":1.23733,"close":1.23795},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 16:06:00","open":1.2379,"high":1.23805,"low":1.23732,"close":1.23738},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 16:05:00","open":1.23784,"high":1.23835,"low":1.23784,"close":1.23791},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 16:04:00","open":1.23847,"high":1.23862,"low":1.23784,"close":1.23789},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 16:03:00","open":1.23909,"high":1.23909,"low":1.23829,"close":1.23853},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 16:02:00","open":1.23923,"high":1.2394,"low":1.23907,"close":1.23915},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 16:01:00","open":1.23909,"high":1.23933,"low":1.23903,"close":1.23927},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 16:00:00","open":1.23904,"high":1.23941,"low":1.23877,"close":1.2392},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:59:00","open":1.23849,"high":1.23926,"low":1.23849,"close":1.23897},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:58:00","open":1.23829,"high":1.23861,"low":1.23815,"close":1.23854},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:57:00","open":1.23864,"high":1.23864,"low":1.23831,"close":1.23836},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:56:00","open":1.23887,"high":1.23901,"low":1.23864,"close":1.23865},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:55:00","open":1.23927,"high":1.23934,"low":1.23893,"close":1.23893},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:54:00","open":1.23937,"high":1.23937,"low":1.23929,"close":1.23932},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:53:00","open":1.23908,"high":1.23944,"low":1.23904,"close":1.23934},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:52:00","open":1.23926,"high":1.23929,"low":1.23903,"close":1.23913},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:51:00","open":1.2392,"high":1.23935,"low":1.23913,"close":1.23932},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:50:00","open":1.23902,"high":1.23932,"low":1.23895,"close":1.23926},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:49:00","open":1.23871,"high":1.2391,"low":1.23871,"close":1.23909},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:48:00","open":1.23891,"high":1.23909,"low":1.23857,"close":1.23876},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:47:00","open":1.23941,"high":1.23945,"low":1.23883,"close":1.23897},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:46:00","open":1.23941,"high":1.23959,"low":1.23941,"close":1.23945},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:45:00","open":1.23951,"high":1.23957,"low":1.23943,"close":1.23945},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:44:00","open":1.2394,"high":1.23957,"low":1.2394,"close":1.23956},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:43:00","open":1.23961,"high":1.23966,"low":1.23944,"close":1.23946},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:42:00","open":1.23891,"high":1.23968,"low":1.23884,"close":1.23967},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:41:00","open":1.23851,"high":1.23906,"low":1.23846,"close":1.23896},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:40:00","open":1.2384,"high":1.23865,"low":1.23836,"close":1.23855},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:39:00","open":1.23869,"high":1.23888,"low":1.23836,"close":1.23845},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:38:00","open":1.23877,"high":1.23894,"low":1.23871,"close":1.23871},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:37:00","open":1.23902,"high":1.23914,"low":1.23881,"close":1.2388299999999999},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:36:00","open":1.23890,"high":1.23908,"low":1.23883,"close":1.23908},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:35:00","open":1.23880,"high":1.23897,"low":1.23866,"close":1.23895},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:34:00","open":1.23843,"high":1.23923,"low":1.23843,"close":1.23885},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:33:00","open":1.23868,"high":1.2389299999999999,"low":1.23843,"close":1.23848},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:32:00","open":1.23933,"high":1.23955,"low":1.2385,"close":1.23874},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:31:00","open":1.23908,"high":1.23942,"low":1.23903,"close":1.23938},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:30:00","open":1.23898,"high":1.23935,"low":1.23882,"close":1.23913},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:29:00","open":1.23873,"high":1.23906,"low":1.23870,"close":1.23903},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:28:00","open":1.23901,"high":1.23907,"low":1.23874,"close":1.23878},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:27:00","open":1.23906,"high":1.23912,"low":1.23888,"close":1.23907},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:26:00","open":1.23875,"high":1.23907,"low":1.23870,"close":1.23907},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:25:00","open":1.23935,"high":1.23942,"low":1.23869,"close":1.23880},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:24:00","open":1.23933,"high":1.23943,"low":1.23911,"close":1.23939},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:23:00","open":1.23983,"high":1.23993,"low":1.23936,"close":1.23937},{"market":"IB","code":"GBP.USD","datetime":"2017-05-23 15:22:00","open":1.23969,"high":1.23998,"low":1.23968,"close":1.23988}]};
history_list = [];
var dom = document.getElementById("container");

//设置商品列表高度
var h_window = document.documentElement.clientHeight;
var h_details_top = $(".details_top").outerHeight(); 
var h_header = $(".tsstu-header").outerHeight(true);
var h_nav = $(".tsstu-nav").outerHeight();
var h_button = $(".tsstu-button").outerHeight();
var h = h_window - h_header - h_nav - h_button;
//alert("windowHight:" + h_window + ",h_details_top:" + h_details_top + ",h_header:" + h_header + ",h_nav:" + h_nav + ",h_button:" + h_button + ",h：" + h)
dom.style.height = h + 'px';


myChart = echarts.init(dom);
var chart_type = "stock";
var minute = 1;
var code = $("#product_code").val();
limit = screen.width > 680 ? 60 : 25;
$(function($) {
	
	reloadChart();
	$(".tsstu-nav li.time").click(function() {
		$(this).siblings().removeClass("active");
		$(this).addClass("active");
		$("#minute").val($(this).attr("data-minute"));
		reloadChart();
	});
	
	$(".tsstu-nav li.switch span").click(function() {
		$(this).siblings().removeClass("active");
		$(this).addClass("active");
		reloadChart();
	});
	
	
});

function reloadChart() {
	minute = $(".tsstu-nav li.time.active").attr("data-minute");
	chart_type = $(".tsstu-nav li.switch span.active").attr("data-type");
	$.ajax({
		url: "quotation/history",
		data: {
			code: code,
			minute: minute,
			type: chart_type,
			limit: limit
		},
		async: false,
		success: function(json) {
			if (json.ok && json.data.length > 0) {
				history_list = json.data; //.reverse();
				var chart_option = change_chart_data(json.data);
				myChart.setOption(chart_option, true);
			}
		}
	});
}

function formatDateTime(inputTime) {    
    var date = new Date(inputTime);  
    var y = date.getFullYear();    
    var m = date.getMonth() + 1;    
    m = m < 10 ? ('0' + m) : m;    
    var d = date.getDate();    
    d = d < 10 ? ('0' + d) : d;    
    var h = date.getHours();  
    h = h < 10 ? ('0' + h) : h;  
    var minute = date.getMinutes();  
    var second = date.getSeconds();  
    minute = minute < 10 ? ('0' + minute) : minute;    
    second = second < 10 ? ('0' + second) : second;   
    return y + '-' + m + '-' + d+' '+h+':'+minute+':'+second;    
};  

function build_ma_data (count, data) {
    var result = [];
    for (var i = 0, len = data.length; i < len; i++) {
        if (i < count) {
            result.push('-');
            continue;
        }
        var sum = 0;
        
        for (var j = 0; j < count; j++) {
            sum += data[i - j][1];
        }
        result.push(sum / count);
    }
    return result;
}
    
function build_diff_data(m_short, m_long, data) {
    var result = [];
    var pre_emashort = 0;
    var pre_emalong = 0;
    for (var i = 0, len = data.length; i < len; i++) {
        var ema_short = data[i][1];
        var ema_long = data[i][1];
        
        if (i != 0) {
            ema_short = (1.0 / m_short) * data[i][1] + (1 - 1.0 / m_short) * pre_emashort;
            ema_long = (1.0 / m_long) * data[i][1] + (1 - 1.0 / m_long) * pre_emalong;
        }

        pre_emashort = ema_short;
        pre_emalong = ema_long;
        var diff = ema_short - ema_long;
        result.push(diff);
    }
    return result;
}
    
function build_dea_data(m, diff) {
    var result = [];
    var pre_ema_diff = 0;
    for (var i = 0, len = diff.length; i < len; i++) {
        var ema_diff = diff[i];
        
        if (i != 0) {
            ema_diff = (1.0 / m) * diff[i] + (1 - 1.0 / m) * pre_ema_diff;
        }
        pre_ema_diff = ema_diff;

        result.push(ema_diff);
    }

    return result;
}
    
function build_macd_data(data, diff, dea) {
    var result = [];
    
    for (var i = 0, len = data.length; i < len; i++) {
        var macd = 2 * (diff[i] - dea[i]);
        result.push(macd.toFixed(5));
    }

    return result;
}


function change_chart_data(history_list) {
    var dates = history_list.map(function(value) {
        //return value.datetime;
    	return formatDateTime(parseInt(value.ctm + "000"));
    });

    var data = history_list.map(function(value) {
        return [ value.open, value.close, value.low, value.high];
    });

    var line_data = history_list.map(function(value) {
        return value.close;
    });

    var diff = build_diff_data(12, 26, data);
    var dea = build_dea_data(9, diff);
    var macd = build_macd_data(data, diff, dea);
    var m5 = build_ma_data(5, data);
    var m10 = build_ma_data(10, data);
    var m20 = build_ma_data(20, data);
    var m30 = build_ma_data(30, data);
    var colorList = ['#c23531','#2f4554', '#61a0a8', '#d48265', '#91c7ae','#749f83',  '#ca8622', '#bda29a','#6e7074', '#546570', '#c4ccd3'];
    var option = {
        animation: false,
        //backgroundColor: 'rgb(25, 25, 26)',
        backgroundColor: '#eee',
        color: colorList,
        legend: {
            show: false,
        },
       /* tooltip: {
            show: true,
            trigger: 'item',
            axisPointer: {
                type: 'cross'
            }
        },*/
     // 提示框
        tooltip: {
            trigger: 'item',           // 触发类型，默认数据触发，见下图，可选为：'item' ¦ 'axis'
            showDelay: 20,             // 显示延迟，添加显示延迟可以避免频繁切换，单位ms
            hideDelay: 100,            // 隐藏延迟，单位ms
            transitionDuration : 0.4,  // 动画变换时间，单位s
            backgroundColor: 'rgba(0,0,0,0.7)',     // 提示背景颜色，默认为透明度为0.7的黑色
            borderColor: '#333',       // 提示边框颜色
            borderRadius: 4,           // 提示边框圆角，单位px，默认为4
            borderWidth: 0,            // 提示边框线宽，单位px，默认为0（无边框）
            padding: 5,                // 提示内边距，单位px，默认各方向内边距为5，
                                       // 接受数组分别设定上右下左边距，同css
            axisPointer : {            // 坐标轴指示器，坐标轴触发有效
                type : 'line',         // 默认为直线，可选为：'line' | 'shadow'
                lineStyle : {          // 直线指示器样式设置
                    color: '#48b',
                    width: 1,
                    type: 'solid'
                },
                shadowStyle : {                       // 阴影指示器样式设置
                    width: 'auto',                   // 阴影大小
                    color: 'rgba(150,150,150,0.3)'  // 阴影颜色
                }
            },
            textStyle: {
            	fontSize: 24,
                color: '#fff'
            }
        },
        grid: [
            {
                top: 5+'%',
                bottom: 30+'%',
                left: 1+'%',
                right: 5+'%',
                height: 65+'%',
                containLabel:true
            },
            {
                top: 75+'%',
                bottom: 0+'%',
                left: 1+'%',
                right: 1+'%',
                height: 25+'%',
                containLabel:true,
            },
        ],
        xAxis: [
            {
                gridIndex: 0,
                type: 'category',
                data: dates,
                axisLine: { 
                    show: false,
                },
                axisTick: {
                    show: false,
                },
                axisLabel: {
                    textStyle: {fontSize: 24, color: 'rgb(100, 100, 100)' },
                    formatter: function (value, index) {
                        if ("d11" == "d1") {
                            var time = value.split(" ")[0];
                            var split = time.split("-");
                            return split[1] + "/" + split[2];
                        }
                        else {
                            var time = value.split(" ")[1];
                            var split = time.split(":");
                            return split[0] + ":" + split[1];
                        }
                    }   
                }
            },
            {
                gridIndex: 1,
                type: 'category',
                data: dates,
                axisLine: { 
                    show: false,
                },
                axisTick: {
                    show: false,
                },
                axisLabel: {
                    show: false,
                },
            },
        ],
        yAxis: [
            {
                gridIndex: 0,
                position: "right",
                scale: true,
                axisLabel: {
                    textStyle: {fontSize: 24, color: 'rgb(100, 100, 100)' },
                    formatter: function (value, index) {
                        return value;
                    }   
                },
                axisLine: { 
                    show: false,
                },
                axisTick: {
                    show: false,
                },
                splitLine: { 
                    show: true,
                    lineStyle: {
                        color: '#aaa',
                    }
                }
//                splitLine: {
//                    lineStyle: {
//                        // 使用深浅的间隔色
//                        color: ['#aaa', '#ddd']
//                    }
//                }
            },
            {
                gridIndex: 1,
                position: "right",
                scale: true,
                axisLabel: {
                    textStyle: {fontSize: 24, color: 'rgb(100, 100, 100)' },
                    formatter: function (value, index) {
                        if (value >= 0) {
                            return "+" + value.toFixed(4);
                        }
                        return value.toFixed(4);
                    }   
                },
                axisLine: { 
                    show: false,
                },
                axisTick: {
                    show: false,
                },
                splitLine: { show: false }
            },
        ],
        dataZoom: [
            { 
                xAxisIndex: [0, 1], 
                type : 'inside' },
        ],
        series: [
			{   
			    name: 'line',
			    type: 'line',
			    xAxisIndex: 0,
			    yAxisIndex: 0,
			    data: chart_type === "line" ? line_data : [], 
			    showSymbol: false,
			    lineStyle:{//折线的颜色
	            normal: {
	                color:"#1ba0fc",
	                width: 1,
	                shadowBlur: 0
	               },
	           },
			    areaStyle: {
			    	normal: {
			    	    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
			    	        offset: 0,
			    	        color: 'rgba(40, 182, 252, 0.85)'
			    	    }, {
			    	        offset: 1,
			    	        color: 'rgba(28, 159, 255, 0.2)'
			    	    }])

			    	}
			    },
			    markPoint: {
                    symbol: "rect",
                    animation: true,
                    symbolSize: [90, 28],
                    symbolOffset: [-43, 0],
                    data: [
                    { 
                        name: '最新价', 
                        x: '99%',
                        yAxis: line_data[line_data.length - 1],
                        value: line_data[line_data.length - 1],
                        label: {
                            normal: {
                            	show:true,
                                position: [ 0, 0 ],
                                textStyle: {
                                	fontSize: 20,
                                    color: "#FFFFFF",
                                },
                                formatter: function(params) {
                                    return params.value;
                                },
                            }
                        },
                    }
                    ]
                },
                markLine: {
                    symbolSize: 0,
                    animation: false,
                    label: {
                        normal: {
                            show: false,
                        }
                    },
                    lineStyle: {
                        normal: {
                            type: 'dashed',
                            width: 1,
                        },
                    },
                    data: [
                        [
                        {
                            name: "实时价格线",
                            x: 10,
                            yAxis: line_data[line_data.length - 1],
                            
                        },
                        {
                        	name: "实时价格线2",
                            x: '90%',
                            yAxis: line_data[line_data.length - 1],
                        }
                        ],
                    ]
                },
			},  
            {
                name: '行情',
                type: 'candlestick',
                xAxisIndex: 0,
                yAxisIndex: 0,
                data: chart_type === "stock" ? data : [],
        		itemStyle: {
                    normal: {
                        color: '#c23531',           // 阳线填充颜色
                        color0: '#314656',   // 阴线填充颜色
                        borderWidth: 1,
                        borderColor: '#c23531',    // 阳线边框颜色
                        borderColor0: '#314656'     // 阴线边框颜色
                    },
                   /* emphasis: {
                        color: '#c23531',         // 阳线填充颜色
                        color0: '#314656',         // 阴线填充颜色
                    	borderWidth: 1,
                        borderColor: '#c23531',    // 阳线边框颜色
                        borderColor0: '#314656'     // 阴线边框颜色
                    }*/
                },
               /* markPoint: {
                    symbol: "rect",
                    animation: true,
                    symbolSize: [60, 28],
                    symbolOffset: [-20, 0],
                    data: [
                    { 
                        name: '最新价', 
                        x: '99%',
                        yAxis: line_data[line_data.length - 1],
                        value: line_data[line_data.length - 1],
                        label: {
                            normal: {
                            	show:true,
                                position: [ 0, 1 ],
                                textStyle: {
                                	fontSize: 24,
                                    color: "#FFFFFF",
                                },
                                formatter: function(params) {
                                    return params.value;
                                },
                            }
                        },
                    }
                    ]
                },*/
                /*markLine: {
                    symbolSize: 0,
                    animation: false,
                    label: {
                        normal: {
                            show: false,
                        }
                    },
                    lineStyle: {
                        normal: {
                            type: 'dashed',
                            width: 1,
                        },
                    },
                    data: [
                        [
                        {
                            name: "实时价格线",
                            x: 3,
                            yAxis: line_data[line_data.length - 1],
                        },
                        {
                        	name: "实时价格线2",
                            x: '100%',
                            yAxis: line_data[line_data.length - 1],
                        }
                        ],
                    ]
                },*/
            },
            {
                name: 'ma5',
                type: 'line',
                xAxisIndex: 0,
                yAxisIndex: 0,
                data: chart_type === "stock" ? m5 : [],
                smooth: true,
                showSymbol: false,
                lineStyle: {
                    normal: {
                        width: 1
                    }
                }
            },
            {
                name: 'ma10',
                type: 'line',
                xAxisIndex: 0,
                yAxisIndex: 0,
                data: chart_type === "stock" ? m10 : [],
                smooth: true,
                showSymbol: false,
                lineStyle: {
                    normal: {
                        width: 1,
                        color: '#86da2b'
                    }
                }
            },
            {
                name: 'ma20',
                type: 'line',
                xAxisIndex: 0,
                yAxisIndex: 0,
                data: chart_type === "stock" ? m20 : [],
                smooth: true,
                showSymbol: false,
                lineStyle: {
                    normal: {
                        width: 1,
                        color: '#ff5382'
                    }
                }
            },
            {
                name: 'ma30',
                type: 'line',
                xAxisIndex: 0,
                yAxisIndex: 0,
                data: chart_type === "stock" ? m30 : [],
                smooth: true,
                showSymbol: false,
                lineStyle: {
                    normal: {
                        width: 1,
                        color: '#3d8ef6'
                    }
                }
            },
            {
                name: 'diff',
                type: 'line',
                data: diff,
                smooth: true,
                showSymbol: false,
                xAxisIndex: 1,
                yAxisIndex: 1,
                lineStyle: {
                    normal: {
                        width: 1,
                        color: '#00ffff'
                    }
                }
            },
            {
                name: 'ema',
                type: 'line',
                data: dea,
                smooth: true,
                showSymbol: false,
                xAxisIndex: 1,
                yAxisIndex: 1,
                lineStyle: {
                    normal: {
                        width: 1,
                        color: '#fe337f'
                    }
                }
            },
            {
                name: 'macd',
                type: 'bar',
                xAxisIndex: 1,
                yAxisIndex: 1,
                itemStyle: {
                    normal: {
                        color: 'rgb(31, 198, 91)',
                        borderColor: 'black',
                    }
                },
                data: macd,
            },
        ]
    };
    return option;
}

